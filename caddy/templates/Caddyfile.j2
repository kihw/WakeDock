# WakeDock Generated Caddyfile
# This file is automatically generated - do not edit manually

{
    admin localhost:2019
    auto_https {{ 'on' if auto_https else 'off' }}
    
    {% if email %}
    email {{ email }}
    {% endif %}
    
    # Global HTTP options
    servers {
        protocol {
            experimental_http3
        }
    }
}

{% for service in services %}
{% if service.domain and service.status == 'running' %}

# Service: {{ service.name }}
{{ service.domain }}{% if service.subdomain %}, {{ service.subdomain }}.{{ base_domain }}{% endif %} {
    # Service metadata
    header {
        X-WakeDock-Service "{{ service.name }}"
        X-WakeDock-Version "{{ service.tag }}"
        -Server
    }
    
    # Reverse proxy to service
    reverse_proxy http://localhost:{{ service.port | default(8080) }} {
        # Health check
        health_uri {{ service.health_path | default('/health') }}
        health_interval {{ service.health_interval | default('30s') }}
        health_timeout {{ service.health_timeout | default('5s') }}
        
        # Headers
        header_up Host {upstream_hostport}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
        
        {% if service.timeout %}
        timeout {{ service.timeout }}
        {% endif %}
    }
    
    {% if service.enable_ssl %}
    # SSL Configuration
    tls {
        {% if service.ssl_cert and service.ssl_key %}
        {{ service.ssl_cert }} {{ service.ssl_key }}
        {% else %}
        # Automatic HTTPS
        on_demand
        {% endif %}
    }
    {% endif %}
    
    {% if service.enable_auth %}
    # Basic Authentication
    basicauth {
        {{ service.auth_user | default('admin') }} {{ service.auth_hash }}
    }
    {% endif %}
    
    {% if service.rate_limit %}
    # Rate limiting
    rate_limit {
        zone static {
            key {remote_host}
            events {{ service.rate_limit.requests | default(100) }}
            window {{ service.rate_limit.window | default('1m') }}
        }
    }
    {% endif %}
    
    # Logging
    log {
        output file {{ log_dir }}/{{ service.name }}.log {
            roll_size 100mb
            roll_keep 5
        }
        format single_field common_log
        level {{ log_level | default('INFO') }}
    }
    
    {% if service.custom_directives %}
    # Custom directives
    {{ service.custom_directives }}
    {% endif %}
}

{% endif %}
{% endfor %}

# Default catch-all for unmatched domains
:80, :443 {
    respond "WakeDock - Service not found" 404
    header Content-Type "text/plain"
    
    log {
        output file {{ log_dir }}/default.log
        format single_field common_log
    }
}
