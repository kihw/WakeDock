{
  "admin": {
    "listen": "localhost:2019"
  },
  "apps": {
    "http": {
      "servers": {
        "srv0": {
          "listen": [":80", ":443"],
          "routes": [
            {% for service in services %}
            {% if service.domain and service.status == 'running' %}
            {
              "@id": "wakedock-{{ service.name }}",
              "match": [
                {
                  "host": ["{{ service.domain }}"{% if service.subdomain %}, "{{ service.subdomain }}.{{ base_domain }}"{% endif %}]
                }
              ],
              "handle": [
                {% if service.enable_auth %}
                {
                  "handler": "authentication",
                  "providers": {
                    "http_basic": {
                      "accounts": [
                        {
                          "username": "{{ service.auth_user | default('admin') }}",
                          "password": "{{ service.auth_hash }}"
                        }
                      ]
                    }
                  }
                },
                {% endif %}
                {
                  "handler": "reverse_proxy",
                  "upstreams": [
                    {
                      "dial": "localhost:{{ service.port | default(8080) }}"
                    }
                  ],
                  "health_checks": {
                    "active": {
                      "uri": "{{ service.health_path | default('/health') }}",
                      "interval": "{{ service.health_interval | default('30s') }}",
                      "timeout": "{{ service.health_timeout | default('5s') }}"
                    }
                  },
                  "headers": {
                    "request": {
                      "set": {
                        "Host": ["{upstream_hostport}"],
                        "X-Real-IP": ["{remote_host}"],
                        "X-Forwarded-For": ["{remote_host}"],
                        "X-Forwarded-Proto": ["{scheme}"]
                      }
                    },
                    "response": {
                      "set": {
                        "X-WakeDock-Service": ["{{ service.name }}"],
                        "X-WakeDock-Version": ["{{ service.tag }}"]
                      },
                      "delete": ["Server"]
                    }
                  }
                }
              ]
            }{% if not loop.last %},{% endif %}
            {% endif %}
            {% endfor %}
          ],
          "logs": {
            "default_logger_name": "wakedock",
            "logger_names": {
              "wakedock": {
                "output": {
                  "module": "file",
                  "filename": "{{ log_dir }}/access.log",
                  "roll": true,
                  "roll_size_mb": 100,
                  "roll_keep": 5
                },
                "format": "common_log",
                "level": "{{ log_level | default('INFO') }}"
              }
            }
          }
        }
      }
    },
    "tls": {
      "automation": {
        "policies": [
          {
            "subjects": [
              {% for service in services %}
              {% if service.domain and service.enable_ssl %}
              "{{ service.domain }}"{% if service.subdomain %}, "{{ service.subdomain }}.{{ base_domain }}"{% endif %}{% if not loop.last %},{% endif %}
              {% endif %}
              {% endfor %}
            ],
            "issuers": [
              {
                "module": "acme",
                "email": "{{ email | default('admin@example.com') }}"
              }
            ]
          }
        ]
      }
    }
  }
}
