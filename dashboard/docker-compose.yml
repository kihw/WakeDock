services:
  # WakeDock Dashboard
  dashboard:
    build:
      context: .
      dockerfile: Dockerfile.prod
      target: production
    container_name: wakedock-dashboard
    ports:
      - "${DASHBOARD_PORT:-3000}:3000"
    environment:
      - NODE_ENV=production
      - PORT=3000
      - PUBLIC_API_URL=${PUBLIC_API_URL:-http://195.201.199.226:8000}
      - PUBLIC_WS_URL=${PUBLIC_WS_URL:-ws://195.201.199.226:8000/ws}
      - PUBLIC_API_TIMEOUT=${PUBLIC_API_TIMEOUT:-30000}
      - PUBLIC_SESSION_TIMEOUT=${PUBLIC_SESSION_TIMEOUT:-86400000}
      - PUBLIC_THEME=${PUBLIC_THEME:-auto}
      - PUBLIC_ENABLE_DEBUG=${PUBLIC_ENABLE_DEBUG:-false}
      - PUBLIC_FEATURE_ANALYTICS=${PUBLIC_FEATURE_ANALYTICS:-true}
      - PUBLIC_FEATURE_NOTIFICATIONS=${PUBLIC_FEATURE_NOTIFICATIONS:-true}
      - PUBLIC_FEATURE_REALTIME=${PUBLIC_FEATURE_REALTIME:-true}
    volumes:
      # Mount logs directory for persistence
      - dashboard-logs:/app/logs
    networks:
      - wakedock-network
    restart: unless-stopped
    # Removed depends_on since API is external
    healthcheck:
      test: [ "CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    labels:
      # Traefik labels for reverse proxy
      - "traefik.enable=true"
      - "traefik.docker.network=wakedock-network"
      - "traefik.http.routers.dashboard.rule=Host(`${DASHBOARD_DOMAIN:-dashboard.localhost}`)"
      - "traefik.http.routers.dashboard.entrypoints=websecure"
      - "traefik.http.routers.dashboard.tls=true"
      - "traefik.http.routers.dashboard.tls.certresolver=letsencrypt"
      - "traefik.http.services.dashboard.loadbalancer.server.port=3000"

      # Dashboard specific labels
      - "wakedock.service=dashboard"
      - "wakedock.version=${DASHBOARD_VERSION:-latest}"
      - "wakedock.environment=${ENVIRONMENT:-production}"

# Network configuration
networks:
  wakedock-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.25.0.0/16

# Volume configuration
volumes:
  dashboard-logs:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./logs/dashboard
